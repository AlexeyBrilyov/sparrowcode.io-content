Напишем приложение с использованием фреймворка MapKit. Научимся добавлять карту, гео-метки,  описание и картинки. Познакомимся с основными понятиями, знание и понимание которых необходимо для работы с карточными API.

- [API](#api)
- [Подключение](#подключение)
    - [Map View](#map-view)
    - [Типы карт](#типы-карт)
    - [Проекции](#проекции)
    - [Подложки](#подложки)
    - [Уровни](#уровни)
    - [Вес](#вес)
- [Метки](#метки)
    - [Location]()
    - [GeoPoint]()
    - [GeoMarker]()
- [Камера]()
- [Данные]()
    - [GeoJSON]()
    - [Описание]()
    - [Изображения]()
- [Шейпы]()
    - [Polyline]()
    - [Polygon]()
    - [GeoDistance]()
    - [GeoPath]()
    - [Route]()

## API
Для создания приложения с картой нам потребуется встроенное или стороннее `API`. Под «API» (Application Programming Interface) будем понимать способ структурного взаимодействия с фреймворком или библиотекой.

`Apple` предоставляет свой собственный фреймворк для работы с картами - `MapKit`. Помимо карт от `Apple` существует множество других. Самыми популярными считаются `Google Maps` и `Open Street Maps`. Они также предоставляют `API` для `Swift`. 

Посмотрим [официальную документацию](https://developer.apple.com/documentation/mapkit/) `MapKit`. Все эти представленные наборы структур, классов и протоколов являются `API` для работы с фреймворком. Для начала работы достаточно импортировать `MapKit` в свой проект:

```swift
import MapKit
```

Подключить `Google Maps` можно несколькими методами, наиболее удобными является использование одного из пакетных менеджеров: `CocoaPods` или `Carthage`. Полное руководство можно посмотреть на [официальном сайте](https://developers.google.com/maps/documentation/ios-sdk/config).

`Open Street Maps` не предоставляют единого фреймворка. Есть набор `iOS`-[библиотек](https://wiki.openstreetmap.org/wiki/Apple_iOS#Libraries_for_developers) с картами `OSM`.

Можно использовать `MapKit`, а в качестве сервера с картами выбрать `Google Maps`, `OSM` или другой. Всё зависит от ваших нужд, детальности карт, частоты их обновления, качества и веса.

Для примера посмотрим на отображение Лондона на картах от `Apple`, `Google` и `OSM`.

**Apple Maps**

![Apple Maps](https://cdn.sparrowcode.io/tutorials/mapkit/london-apple.png)

**Google Maps**

![Google Maps](https://cdn.sparrowcode.io/tutorials/mapkit/london-g-maps.png)

**Open Street Maps**

![OSM Maps](https://cdn.sparrowcode.io/tutorials/mapkit/london-osm.png)

## Подключение
### Map View
Карта в проект добавляется аналогично любой другой `View`. Для `UIKit` предусмотрен класс `MKMapView`, а для `SwiftUI` - структура `Map`. В этом туториале мы будем работать с `UIKit`.

Создадим проект с названием `MapKitTutorial`. Выберите `Storyboard`. `Storyboard`-файл мы трогать не будем, всё сделаем через код.

Проект имеет стандартную начальную файловую структуру:
````
```
├── MapKitTutorial
│   ├── AppDelegate
│   ├── SceneDelegate
│   ├── ViewController
│   ├── Main
│   ├── Assets
│   ├── LaunchScreen
│   ├── Info
```
````

Переходим в файл `ViewController `. Импортируем `MapKit`.  В теле класса создаём постоянную `mapView` типа `MKMapView`. В качестве значения укажем ей сомовызывающуюся функцию, возвращающую экземпляр `MKMapView`.

```swift
import UIKit
import MapKit

class ViewController: UIViewController {

    let mapView: MKMapView = {
        let map = MKMapView()
        map.translatesAutoresizingMaskIntoConstraints = false
        
        return map
    }()
}
```

Этой строкой мы включили возможность выставлять `anchors` для `mapView`:

```swift
map.translatesAutoresizingMaskIntoConstraints = false
```

Создадим новый файл `Swift File` с названием `Helper`.  В этом файле будут вспомогательные объекты, так мы не будем захламлять класс `ViewController`.

Переходим в `Helper`. Создадим структуру `AnchorsSetter` со `static` методом `setAllSides(for view: UIView)`, который выставит `view` в размер его `superview` с учётом верхней `safeArea`.

```swift
struct AnchorsSetter {
    
    static func setAllSides(for view: UIView) {
        if let superview = view.superview {
            NSLayoutConstraint.activate([
                view.topAnchor.constraint(equalTo: superview.safeAreaLayoutGuide.topAnchor),
                view.rightAnchor.constraint(equalTo: superview.rightAnchor),
                view.bottomAnchor.constraint(equalTo: superview.bottomAnchor),
                view.leftAnchor.constraint(equalTo: superview.leftAnchor)
            ])
        }
    }
}
```

Переключаемся на `ViewController`. Во `viewDidLoad()` добавляем нашу карту (`mapView`) в основной `view` и позиционируем её.

```swift
override func viewDidLoad() {

    super.viewDidLoad()
    view.addSubview(mapView)
    AnchorsSetter.setAllSides(for: mapView, with: view)
}
```

Запускаем симулятор и видим нашу карту.

![Базовая карта](https://cdn.sparrowcode.io/tutorials/mapkit/simple-mapview.png)

### Типы карт
По типу отображения карты можно разделить на:
- `Спутник` - карта составлена из совокупности снимков со спутника
- `Схема` - карта составлена схематическим образом
- `Гибрид` - объекты схематически нанесены на совокупность спутниковых снимков, иными словами - одновременное отображение `Спутника` и `Схемы`

Пользователям обычно не требуется спутниковая карта без отображения на ней дорог, объектов, границ и названий. Поэтому разработчики делят карты на два типа для пользователей: `Схему` и `Спутник`, называя спутником именно гибридную карту. Вы неоднократно могли видеть именно эти два типа в навигаторах. Посмотрим на них.

**Схема**

![Схема](https://cdn.sparrowcode.io/tutorials/mapkit/scheme-map.png)

**Спутник**

![Спутник](https://cdn.sparrowcode.io/tutorials/mapkit/satellite-map.png)

В нашем приложении мы видим именно схематическую карту.

За изменение типа отображаемой карты в `MapKit` отвечает свойство `mapType`, принимающее значения типа `MKMapType`. `MKMapType` - перечисление, содержащее следующие кейсы:

- `standard` - карта улиц, показывающая расположение всех дорог и названия некоторых дорог
- `satellite` - спутниковые снимки местности
- `hybrid` - спутниковые снимки местности с информацией о дорогах и названиями дорог, расположенной поверх снимков
- `satelliteFlyover` - спутниковый снимок местности с данными об **облёте**, если таковые имеются
- `hybridFlyover` - гибридный спутниковый снимок с данными **пролёта**, если таковые имеются
- `mutedStandard` - карта улиц, на которой ваши данные выделены поверх основных деталей карты

Изменим тип нашей карты и посмотрим разницу.

```swift
override func viewDidLoad() {
        
        // ...
        
        mapView.mapType = .satellite
    }
```

![mapView Satellite](https://cdn.sparrowcode.io/tutorials/mapkit/mapview-satellite.png)

```swift
override func viewDidLoad() {
        
        // ...
        
        mapView.mapType = .hybrid
    }
```

![mapView Hybrid](https://cdn.sparrowcode.io/tutorials/mapkit/mapview-hybrid.png)

Карты делятся на множество категорий в зависимости от применения. Вот некоторые из них:
- автомобильные навигационные;
- географические;
- геологические;
- гидрогеологические;
- ландшафтные;
- морские навигационные;
- тектонические;
- топографические;
- цифровые;
- электронные.

Карта в нашем приложении относится к электронным. Каждая такая категория может представлять отдельный слой на электронной карте. Их можно отображать совместно или по отдельности. 

Карта представляет собой изображение, сформированное на основе набора геоданных. Эти данные собираются, обрабатываются и подготавливаются специалистами. Итоговые карты выставляются на продажу. Основными поставщиками карт являются разработчики ГИС (геоинформационных систем). Стоимость таких карт для рядового разработчика довольно высока. Есть множество бесплатных карт, таких как `OSM`, но стоит принять во внимание точность и частоту обновления данных.

### Проекции

Привычные нам карты - плоские, но мы знаем, что Земля имеет форму геоида. Когда мы смотрим на глобус, то видим все объекты в правильных пропорциях. На картах же мы видим проекцию геоида на плоскость. Таких проекций очень много. В привычной нам проекции материки выглядят иначе, чем они есть на самом деле.

Посмотрим на схематичное и спутниковое изображение Земли.

**Схема**

![Схема геоид](https://cdn.sparrowcode.io/tutorials/mapkit/globe-scheme.png)

**Спутник**

![Спутник геоид](https://cdn.sparrowcode.io/tutorials/mapkit/globe-satellite.png)

Самыми распространёнными проекциями являются:
- Меркатора;
- Азимутальная;
- Каврайского;
- Пирса;
- Робинсона.

`Apple Maps`, `Google Maps` и `OSM` предоставляют свои карты в проекции `Меркатора`. Мы будем работать с ней.

Посмотрим на соотношения между площадью каждой страны в проекции `Меркатора` и истинной площадью:

![Соотношение площадей по Меркатору. Автор Гифки: Jakub Nowosad - собственная работа, CC BY-SA 4.0, https://commons.wikimedia.org/w/index.php?curid=73955926)](https://cdn.sparrowcode.io/tutorials/mapkit/mer-dif.png)

Такая проекция не сохраняет площади, поскольку имеет разный масштаб на разных участках. Больше всего разница в масштабе у тех объектов, что расположены ближе к полюсам (дальше от экватора), потому что там геоид сужается.

В `MapKit` это учитывается при различных расчётах, однако, необходимо понимание основных принципов. В дальнейшем мы рассмотрим это более детально.

### Подложки

"Подложка" - термин, означающий базовую карту или карту-основу, использующуюся в качестве информационного фона. Мы уже рассмотрели карты по типам и категориям, уделим внимание форматам. 

Рассмотрим на примере [`Google Earth`](https://earth.google.com/web/). Первое, что можно отметить - время загрузки. Обычно, когда вы открываете карты, то подгружается только её часть, затем участки в этой области, пока она полностью не будет загружена. В `Google Earth` же происходит подгрузка так, что глаз не успевает заметить разделения на тайлы. "Тайлами" называют квадратные (плиточные) изображения, на которые разбиваются карты. В совокупности тайлы дают впечатление большой единой картинки.

Мы видим глобус, по сути - планету Земля.

![Google Earth](https://cdn.sparrowcode.io/tutorials/mapkit/g-earth.png)

С точки зрения разработки это математически посчитанная фигура - геоид, с координатной разметкой, на которую натянули картинку. Это картинка - подложка. При увеличении, объекты будут отображаться поверх неё. Подложка может представлять собой как 2D-изображение, так и 3D. В отличие от 2D-изображения 3D-изображение помимо широт и долгот хранит информацию о высоте в каждой точке. Такая подложка называется `terrain`. Информация о высотах также может идти совместно с 2D-изображением формата `GeoTiff`, но по отображению будет отличаться от `terrain`.

Мы можем переключиться и посмотреть разницу отображений 2D и 3D.

**2D**

![Google Earth 2D](https://cdn.sparrowcode.io/tutorials/mapkit/g-earth-2d.png)

**3D**

![Google Earth 3D](https://cdn.sparrowcode.io/tutorials/mapkit/g-earth-3d.png)

Может показаться, что сильной разницы нет. Для явного различия добавим измерение расстояния. 

**Измерение 2D**

![Google Earth Measure 2D](https://cdn.sparrowcode.io/tutorials/mapkit/g-earth-measure-2d.png)

**Измерение 3D**

![Google Earth Measure 3D](https://cdn.sparrowcode.io/tutorials/mapkit/g-earth-measure-3d.png)

Обратите внимание, что при разных отображениях мы получаем одинаковое расстояние измерений, это происходит из-за учёта высоты в обоих случаях.

### Уровни

Мы выяснили, что карта разбивается на тайлы. Это позволяет увеличить скорость загрузки, так как нет необходимости грузить полное изображение, достаточно загрузить только необходимую область.

Для удобства масштабирования и скорости просмотра используют специальный механизм - карта представляется в виде пирамиды тайлов.

![Пирамида тайлов](https://cdn.sparrowcode.io/tutorials/mapkit/pyramid-tiles.png)

Самая большая область помещается в самое маленькое изображение - один тайл. Каждое последующее увеличение области представляет собой новый уровень, в котором эта область разделяется на большее число тайлов и т.д. Тайлы имеют одинаковый размер. Уровни также могут называться `zoom`, `level` и `zoom level`. Не у всех `maps API` эти уровни сопадают. Так 10-й уровень одной ГИС может соответсвовать 12-му уровню другой.

![Zoom Levels](https://cdn.sparrowcode.io/tutorials/mapkit/zoom-levels.png)

Упорядоченная совокупность тайлов представляет собой матрицу. У каждого тайла есть своё название по позиции в матрице. Тайл также обладает координатными границами. При поиске области по координатам, алгоритм ищет тайл, в который попадает эта область, обращается к нему по матричной разметке и подгружает. 

Давайте посмотрим, как это выглядит в динамике.

![Video Tiles Loading]()

### Вес

Важно учитывать, что совокупность тайлов даёт нам изображение высокого качества, размер которого довольн велик. Чем больше область, которую необходимо исследовать, тем больше тайлов и уровней требуется, соответственно возрастает и вес карты. На вес влияет и сопутствующая информация, он может достигать нескольких десятков, а порой и сотен гигабайт. Поэтому подгрузка по областям очень удобна.

Есть несколько способов загрузки, хранения и очищения кэша геоданных. 

Первый наиболее распространён и удобен, когда важна скорость отображения и размер оперативной памяти небольшой. Уровень загружается и сохраняется в кеш. При зуме подгружается следующий уровень, а предыдущий очищается из кеша. Так, при зуме в плюс и минус каждый раз будет происходить загрузка уровня и очистка предыдущего. Используется в мобильных приложениях.

Другой способ подразумевает сохранение в кеше загруженных уровней, но требует достаточного объёма оперативной памяти, потому применяется в основном на ПК-платформах в специальных ГИС.

Можно скачивать карты на определённый район на устройство, чтоб не загружать каждый раз и иметь возможность трекинга даже при слабом интернете. Такой режим называют "оффлайн картами".

## Метки

Само по себе изображение местности бесполезно обычному пользователю без дополнительных опознавательных знаков. Это могут быть подписи, метки, цветовые и схематические выделения объектов, областей, геопозиции, маршрута и т.д. Для нанесения подобных обозначений и поиска на местности используют системы координат. Чаще всего используют градусы или прямоугольные координаты.

Основные системы координат `maps API`:
- градусы (геодезические координаты `WGS84` (`EPSG:4326`))
- прямоугольные (метры, сферическая проекция Меркатора (`EPSG:3857`))
- пиксели (`XY` координаты пикселей экрана в уровне (`zoom`))
- координаты тайлов (Tile Map Service (`ZXY`))

`MapKit` использует градусы (`WGS84`).
